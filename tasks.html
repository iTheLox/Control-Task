<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>GestiÃ³n de Tareas Moderna</title>
Â  Â  <!-- La ruta al archivo CSS externo es mantenida tal como la proporcionaste -->
Â  Â  <link rel="stylesheet" href="./css/styletask.css">
</head>
<body class="task-body">
Â  Â  <div class="task-container">
Â  Â  Â  Â  <header class="task-header">
Â  Â  Â  Â  Â  Â  <h1 class="main-title">Mis Tareas âœ¨</h1>
Â  Â  Â  Â  Â  Â  <button id="logout-btn" class="btn btn-secondary">Cerrar SesiÃ³n</button>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <div class="card task-creator">
Â  Â  Â  Â  Â  Â  <h2 class="card-subtitle">Nueva Tarea</h2>
Â  Â  Â  Â  Â  Â  <form id="create-task-form">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label" for="task-title">TÃ­tulo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input class="form-input" id="task-title" type="text" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label" for="task-description">DescripciÃ³n (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="form-input" id="task-description" rows="2"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Crear Tarea
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="creation-message" class="message-box hidden mt-4"></p>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- === SECCIÃ“N DE IMPORTACIÃ“N EXCEL AÃ‘ADIDA === -->
Â  Â  Â  Â  <div class="card import-excel-section">
Â  Â  Â  Â  Â  Â  <h2 class="card-subtitle">Importar Tareas desde Excel</h2>
Â  Â  Â  Â  Â  Â  <p class="mb-2">El archivo debe contener una columna llamada **TÃ­tulo** y opcionalmente **DescripciÃ³n**.</p>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Este es el botÃ³n funcional para cargar el archivo -->
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv" class="form-input">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p id="import-message" class="message-box hidden mt-4"></p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <!-- ============================================ -->

Â  Â  Â  Â  <div class="card task-list-section">
Â  Â  Â  Â  Â  Â  <h2 class="card-subtitle">Tareas Pendientes</h2>
Â  Â  Â  Â  Â  Â  <div id="tasks-list" class="task-items-container">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="loading-message" class="loading-text">Cargando tareas...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p id="list-message" class="message-box hidden mt-4"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card task-list-section">
Â  Â  Â  Â  Â  Â  <h2 class="card-subtitle completed-title">Tareas Completadas <span class="check-mark">âœ”ï¸</span></h2>
Â  Â  Â  Â  Â  Â  <div id="completed-tasks-list" class="task-items-container">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="no-completed-message" class="loading-text">No hay tareas completadas.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <div id="edit-modal" class="modal-backdrop hidden">
Â  Â  Â  Â  <div class="modal-content modern-card">
Â  Â  Â  Â  Â  Â  <h3 class="card-subtitle">Editar Tarea</h3>
Â  Â  Â  Â  Â  Â  <form id="edit-task-form">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="edit-task-id">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label" for="edit-title">TÃ­tulo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input class="form-input" id="edit-title" type="text" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label" for="edit-description">DescripciÃ³n</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="form-input" id="edit-description" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">Guardar Cambios</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" onclick="document.getElementById('edit-modal').classList.add('hidden')">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="edit-message" class="message-box hidden mt-4"></p>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <!-- LibrerÃ­a SheetJS para parsear archivos Excel (xlsx, xls, csv) -->
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

Â  Â  <script>
Â  Â  // Base URL del API
Â  Â  const API_URL = 'http://localhost:8000/tasks';

Â  Â  function logout() {
Â  Â  Â  Â  localStorage.removeItem('access_token');
Â  Â  Â  Â  localStorage.removeItem('user_info'); 
Â  Â  Â  Â  // Redirigir a la pÃ¡gina de login (index.html) localmente
Â  Â  Â  Â  window.location.href = 'index.html'; 
Â  Â  }

Â  Â  // ğŸ’¡ CORRECCIÃ“N DE FECHA: FunciÃ³n robusta para formatear y manejar 'Invalid Date'
Â  Â  function parseDate(dateString) {
Â  Â  Â  Â  if (!dateString) return 'Fecha no disponible';

Â  Â  Â  Â  // Intentar parsear la fecha
Â  Â  Â  Â  let dateObj = new Date(dateString);

Â  Â  Â  Â  // Si es Invalid Date, intentar arreglar el formato (comÃºn en backends)
Â  Â  Â  Â  if (isNaN(dateObj.getTime())) {
Â  Â  Â  Â  Â  Â  // Reemplazar espacio con 'T' para formato ISO compatible
Â  Â  Â  Â  Â  Â  let fixedString = dateString.replace(' ', 'T');
Â  Â  Â  Â  Â  Â  dateObj = new Date(fixedString);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isNaN(dateObj.getTime())) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si sigue siendo invÃ¡lida, devolver solo la parte de la fecha si es posible
Â  Â  Â  Â  Â  Â  Â  Â  return dateString.split('T')[0].split(' ')[0] || 'Invalid Date';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Formato final: DD/MM/AAAA (o el formato local)
Â  Â  Â  Â  return dateObj.toLocaleDateString();
Â  Â  }


Â  Â  // ğŸ¯ FunciÃ³n para Marcar/Desmarcar Tarea como Completada
Â  Â  async function completeTask(taskId, isCompleted) {
Â  Â  Â  Â  const token = localStorage.getItem('access_token');
Â  Â  Â  Â  const endpoint = `${API_URL}/${taskId}`;
Â  Â  Â  Â  // Enviar PATCH con el campo 'completed' que el backend espera
Â  Â  Â  Â  const body = { completed: isCompleted };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(endpoint, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'PATCH',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${token}`
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(body)
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Leer el posible error del servidor
Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ message: 'Error desconocido del servidor.' }));
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.message || `Error en la API: ${response.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('edit-modal').classList.add('hidden');
Â  Â  Â  Â  Â  Â  await loadTasks(); 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error al completar/desmarcar tarea:', error);
Â  Â  Â  Â  Â  Â  // Reemplazo de alert()
Â  Â  Â  Â  Â  Â  console.log(`[AVISO]: No se pudo ${isCompleted ? 'completar' : 'desmarcar'} la tarea. Detalle: ${error.message}`);
Â  Â  Â  Â  }
Â  Â  }


Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  const token = localStorage.getItem('access_token');
Â  Â  Â  Â  const tasksList = document.getElementById('tasks-list');
Â  Â  Â  Â  const completedTasksList = document.getElementById('completed-tasks-list');
Â  Â  Â  Â  const loadingMessage = document.getElementById('loading-message');
Â  Â  Â  Â  const editModal = document.getElementById('edit-modal');
Â  Â  Â  Â  const editForm = document.getElementById('edit-task-form');
Â  Â  Â  Â  
Â  Â  Â  Â  // Elementos para la nueva funciÃ³n de importaciÃ³n
Â  Â  Â  Â  const excelFileInput = document.getElementById('excel-file-input');
Â  Â  Â  Â  const importMessageBox = document.getElementById('import-message');


Â  Â  Â  Â  if (!token) {
Â  Â  Â  Â  Â  Â  window.location.href = '/'; 
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  Â  Â  if (logoutBtn) {
Â  Â  Â  Â  Â  Â  logoutBtn.addEventListener('click', logout);
Â  Â  Â  Â  }

Â  Â  Â  Â  // ğŸ”„ Renderizar una sola tarea 
Â  Â  Â  Â  function renderTask(task) {
Â  Â  Â  Â  Â  Â  const taskItem = document.createElement('div');
Â  Â  Â  Â  Â  Â  // Usar la propiedad 'completed' que devuelve la API
Â  Â  Â  Â  Â  Â  taskItem.className = `task-item modern-card ${task.completed ? 'completed-task' : 'pending-task'}`; 
Â  Â  Â  Â  Â  Â  taskItem.setAttribute('data-id', task.id);

Â  Â  Â  Â  Â  Â  let actionButtons = '';
Â  Â  Â  Â  Â  Â  if (task.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary complete-btn" data-id="${task.id}" data-completed="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Desmarcar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger delete-btn" data-id="${task.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Eliminar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary btn-complete complete-btn" data-id="${task.id}" data-completed="true">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Completar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-action edit-btn" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-id="${task.id}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-title="${task.title}" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-description="${task.description || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger delete-btn" data-id="${task.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Eliminar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Fechas (Usando la funciÃ³n corregida parseDate) ---
Â  Â  Â  Â  Â  Â  const createdDateStr = parseDate(task.created_at);
Â  Â  Â  Â  Â  Â  const completedDateHtml = task.completed && task.completed_at 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<span class="task-date-completed">Completada: ${parseDate(task.completed_at)}</span>` 
Â  Â  Â  Â  Â  Â  Â  Â  : '';

Â  Â  Â  Â  Â  Â  taskItem.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="task-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="task-title">${task.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="task-description">${task.description || 'Sin descripciÃ³n'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="task-dates">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="task-date-created">Creada: ${createdDateStr}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${completedDateHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="task-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  return taskItem;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ğŸ”„ Cargar/Filtrar tareas del backend
Â  Â  Â  Â  Â  Â  Â  Â  async function loadTasks(query = '') {
Â  Â  Â  Â  Â  Â  loadingMessage.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  tasksList.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  completedTasksList.innerHTML = ''; 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}${query ? '?' + query : ''}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${token}` }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 401) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('SesiÃ³n expirada. Por favor, inicie sesiÃ³n de nuevo.'); // Reemplazo de alert()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logout();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Hacer la funciÃ³n accesible desde el scope global para que funciones
Â  Â  Â  Â  Â  Â  Â  Â  // definidas fuera de DOMContentLoaded (p.ej. completeTask) puedan llamarla.
Â  Â  Â  Â  Â  Â  Â  Â  window.loadTasks = loadTasks;
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Error al cargar/filtrar tareas');

Â  Â  Â  Â  Â  Â  Â  Â  const allTasks = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  loadingMessage.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const pendingTasks = allTasks.filter(task => !task.completed);
Â  Â  Â  Â  Â  Â  Â  Â  const completedTasks = allTasks
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(task => task.completed)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at)); 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (pendingTasks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksList.innerHTML = '<p class="text-center text-gray-500">No hay tareas pendientes.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendingTasks.forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksList.appendChild(renderTask(task));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (completedTasks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedTasksList.innerHTML = '<p class="text-center text-gray-500">No hay tareas completadas.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedTasks.forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedTasksList.appendChild(renderTask(task));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  loadingMessage.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  tasksList.innerHTML = `<p class="message-box error">No se pudieron cargar las tareas: ${error.message}.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // âŒ Eliminar tarea (funcional)
Â  Â  Â  Â  async function deleteTask(taskId) {
Â  Â  Â  Â  Â  Â  // Reemplazo de confirm()
Â  Â  Â  Â  Â  Â  if (!window.confirm('Â¿EstÃ¡s seguro de que quieres eliminar esta tarea?')) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/${taskId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${token}` }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Error al eliminar tarea');
Â  Â  Â  Â  Â  Â  Â  Â  await loadTasks(); 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Reemplazo de alert()
Â  Â  Â  Â  Â  Â  Â  Â  console.log('No se pudo eliminar la tarea.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // âœï¸ Mostrar modal de ediciÃ³n
Â  Â  Â  Â  function showEditModal(task) {
Â  Â  Â  Â  Â  Â  document.getElementById('edit-task-id').value = task.id;
Â  Â  Â  Â  Â  Â  document.getElementById('edit-title').value = task.title;
Â  Â  Â  Â  Â  Â  document.getElementById('edit-description').value = task.description;
Â  Â  Â  Â  Â  Â  document.getElementById('edit-message').classList.add('hidden'); 
Â  Â  Â  Â  Â  Â  editModal.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  // ğŸ’¾ Manejar envÃ­o del formulario de ediciÃ³n (PATCH)
Â  Â  Â  Â  editForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  const taskId = document.getElementById('edit-task-id').value;
Â  Â  Â  Â  Â  Â  const title = document.getElementById('edit-title').value;
Â  Â  Â  Â  Â  Â  const description = document.getElementById('edit-description').value;
Â  Â  Â  Â  Â  Â  const messageBox = document.getElementById('edit-message');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/${taskId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'PATCH',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${token}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Solo enviamos los campos que se editan
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ title, description }) 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Leer el error del servidor para debug
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ message: 'Error desconocido del servidor.' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.message || `Error en la API: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  messageBox.textContent = 'Tarea actualizada con Ã©xito. âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.className = 'message-box success mt-4';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadTasks();
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000); 

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al editar tarea:', error);
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.textContent = `Error al actualizar la tarea. âŒ Detalle: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.className = 'message-box error mt-4';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });


Â  Â  Â  Â  // ğŸ§ DelegaciÃ³n de eventos para botones de acciÃ³n
Â  Â  Â  Â  [tasksList, completedTasksList].forEach(container => {
Â  Â  Â  Â  Â  Â  container.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (target.classList.contains('delete-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteTask(target.getAttribute('data-id'));
Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.classList.contains('edit-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showEditModal({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: target.getAttribute('data-id'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: target.getAttribute('data-title'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: target.getAttribute('data-description')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.classList.contains('complete-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCompleted = target.getAttribute('data-completed') === 'true';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completeTask(target.getAttribute('data-id'), isCompleted);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // ğŸ“ Crear nueva tarea (POST) - CORREGIDO
Â  Â  Â  Â  document.getElementById('create-task-form').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  const title = document.getElementById('task-title').value;
Â  Â  Â  Â  Â  Â  const description = document.getElementById('task-description').value;
Â  Â  Â  Â  Â  Â  const messageBox = document.getElementById('creation-message');

Â  Â  Â  Â  Â  Â  Â  Â  // No enviamos 'created_at' ni 'is_completed' desde el cliente; la BD lo maneja.
Â  Â  Â  Â  Â  Â  Â  Â  // Enviamos explÃ­citamente 'completed: false' para mayor claridad.
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${token}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ message: 'Error desconocido del servidor.' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.message || `Error en la API: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  messageBox.textContent = 'Tarea creada con Ã©xito. âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.className = 'message-box success mt-4';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('create-task-form').reset();
Â  Â  Â  Â  Â  Â  Â  Â  await loadTasks(); 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => messageBox.classList.add('hidden'), 2000);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al crear tarea:', error);
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.textContent = `No se pudo crear la tarea. âŒ Detalle: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.className = 'message-box error mt-4';
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  
Â  Â  Â  Â  // ==========================================
Â  Â  Â  Â  // ğŸš€ LÃ“GICA DE IMPORTACIÃ“N DE EXCEL/CSV
Â  Â  Â  Â  // ==========================================

        /**
         * Muestra un mensaje en el Ã¡rea de importaciÃ³n.
         * @param {string} text - El texto del mensaje.
         * @param {boolean} [isError=false] - Si es un mensaje de error.
         */
        function showImportMessage(text, isError = false) {
            importMessageBox.textContent = text;
            importMessageBox.className = `message-box ${isError ? 'error' : 'success'} mt-4`;
            importMessageBox.classList.remove('hidden');
            if (!isError) {
                setTimeout(() => importMessageBox.classList.add('hidden'), 5000);
            }
        }

        /**
         * Importa una sola tarea al backend.
         * @param {object} taskData - Datos de la tarea (title, description).
         * @param {string} token - Token de autenticaciÃ³n.
         * @returns {Promise<boolean>} - True si la importaciÃ³n fue exitosa.
         */
        async function importTask(taskData, token) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: taskData.title,
                        description: taskData.description || '',
                        completed: false
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Error desconocido al importar.' }));
                    throw new Error(errorData.message || `API Error: ${response.status}`);
                }
                return true;
            } catch (error) {
                console.error(`Error al importar tarea "${taskData.title}":`, error);
                return false;
            }
        }

        /**
         * Maneja la subida, parseo e importaciÃ³n del archivo Excel.
         * @param {Event} e - Evento de cambio de archivo.
         */
        function handleExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            showImportMessage(`Procesando archivo: ${file.name}...`, false);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Usamos XLSX.read con el ArrayBuffer
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Asumimos que queremos la primera hoja
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convertir la hoja a formato JSON
                    const jsonTasks = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1, // Obtener como array de arrays para mapear
                        defval: "", // Reemplazar celdas vacÃ­as con ""
                        raw: false // Mantener formato de texto
                    });

                    if (jsonTasks.length < 2) { // Necesita al menos cabecera y una fila de datos
                        showImportMessage('El archivo Excel no contiene datos de tareas en la primera hoja o estÃ¡ vacÃ­o.', true);
                        return;
                    }

                    const token = localStorage.getItem('access_token');
                    if (!token) {
                         showImportMessage('Error de autenticaciÃ³n. Por favor, inicie sesiÃ³n de nuevo.', true);
                         return;
                    }

                    // Mapeo de cabeceras (para hacerlo insensible a mayÃºsculas/minÃºsculas)
                    const headerRow = jsonTasks[0].map(h => String(h).toLowerCase().trim());
                    const titleIndex = headerRow.indexOf('tÃ­tulo');
                    const descriptionIndex = headerRow.indexOf('descripciÃ³n');

                    if (titleIndex === -1) {
                         showImportMessage('Error: La columna "TÃ­tulo" es obligatoria y no se encontrÃ³.', true);
                         return;
                    }

                    const tasksToImport = [];
                    // Iterar sobre las filas de datos (a partir del Ã­ndice 1)
                    for (let i = 1; i < jsonTasks.length; i++) {
                        const row = jsonTasks[i];
                        const title = row[titleIndex];
                        const description = descriptionIndex !== -1 ? row[descriptionIndex] : '';

                        if (title && String(title).trim() !== '') {
                             tasksToImport.push({
                                title: String(title).trim(), 
                                description: String(description || '').trim()
                            });
                        }
                    }

                    if (tasksToImport.length === 0) {
                        showImportMessage('No se encontraron tareas vÃ¡lidas (con tÃ­tulo) para importar.', true);
                        return;
                    }

                    let successfulImports = 0;
                    let failedImports = 0;

                    showImportMessage(`Enviando ${tasksToImport.length} tareas al servidor. Esto puede tardar...`, false);

                    // Enviar las tareas a la API una por una
                    for (const task of tasksToImport) {
                        if (await importTask(task, token)) {
                            successfulImports++;
                        } else {
                            failedImports++;
                        }
                    }

                    // Reportar el resultado y recargar la lista de tareas
                    if (successfulImports > 0) {
                        showImportMessage(`ImportaciÃ³n finalizada. âœ… ${successfulImports} tareas creadas. ${failedImports > 0 ? `(${failedImports} fallidas)` : ''}`);
                        await loadTasks();
                    } else {
                         showImportMessage(`ImportaciÃ³n fallida. âŒ No se pudo crear ninguna tarea. Revise el formato del archivo y la conexiÃ³n con el backend.`, true);
                    }


                } catch (error) {
                    console.error('Error durante el procesamiento del archivo Excel:', error);
                    showImportMessage(`Error al procesar el archivo. âŒ Detalle: ${error.message}. AsegÃºrese de que sea un archivo Excel vÃ¡lido.`, true);
                }
            };
            
            reader.onerror = function() {
                showImportMessage('No se pudo leer el archivo.', true);
            }

            reader.readAsArrayBuffer(file);
            // Limpiar el input para permitir la subida del mismo archivo de nuevo
            e.target.value = ''; 
        }

        // ğŸ§ Asignar listener al input de archivo
        excelFileInput.addEventListener('change', handleExcelFile);

Â  Â  Â  Â  // ğŸš€ Cargar tareas al iniciar
Â  Â  Â  Â  loadTasks();
Â  Â  });
</script>
</body>
</html>